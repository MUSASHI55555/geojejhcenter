// app/api/gallery/detail/route.ts

import { NextResponse } from "next/server"
import { head } from "@vercel/blob"
import type { GalleryItem, GalleryImage } from "@/lib/gallery-types"

export const runtime = "nodejs"
export const dynamic = "force-dynamic"

type RawGallery = any

function errorJson(message: string, status = 400) {
  return NextResponse.json({ ok: false, error: message }, { status })
}

function normalizeImages(raw: any): GalleryImage[] {
  if (!Array.isArray(raw)) return []

  return raw
    .filter((img: any) => img && typeof img.url === "string")
    .map((img: any) => ({
      url: String(img.url),
      alt: typeof img.alt === "string" ? img.alt : undefined,
    }))
}

function normalizeGalleryItem(raw: RawGallery, key: string): GalleryItem | null {
  if (!raw || typeof raw !== "object") return null
  if (!raw.title) return null

  const createdAt =
    typeof raw.createdAt === "string" ? raw.createdAt : new Date().toISOString()
  const updatedAt =
    typeof raw.updatedAt === "string" ? raw.updatedAt : undefined

  const viewCount =
    typeof raw.viewCount === "number"
      ? raw.viewCount
      : typeof raw.views === "number"
      ? raw.views
      : 0

  const images = normalizeImages(raw.images)

  if (images.length === 0) {
    console.error("[GET /api/gallery/detail] No valid images found", key)
    return null
  }

  let thumbnail: GalleryItem["thumbnail"] = undefined
  if (raw.thumbnail && typeof raw.thumbnail === "object") {
    const idx = raw.thumbnail.imageIndex
    if (typeof idx === "number" && idx >= 0 && idx < images.length) {
      thumbnail = {
        imageIndex: idx,
        focus: raw.thumbnail.focus || "center",
      }
    }
  }

  return {
    key,
    title: String(raw.title),
    description: typeof raw.description === "string" ? raw.description : undefined,
    category: raw.category || undefined,
    createdAt,
    updatedAt,
    images,
    thumbnail,
    viewCount,
    author: raw.author || "ê´€ë¦¬ì",
  }
}

/**
 * galleries/... â†’ galleries-views/... ë¡œ ì¹´ìš´í„° blob key ë³€í™˜
 */
function toCounterKey(decoded: string): string {
  return decoded.replace(/^galleries\//, "galleries-views/")
}

/**
 * ì¹´ìš´í„° Blobì—ì„œ viewCount ì½ì–´ì˜¤ê¸° (ì—†ê±°ë‚˜ ê¹¨ì ¸ ìˆìœ¼ë©´ undefined ë°˜í™˜)
 */
async function readCounterViews(decoded: string): Promise<number | undefined> {
  const counterKey = toCounterKey(decoded)

  const meta = await head(counterKey).catch((e: any) => {
    if (e?.status !== 404) {
      console.error(
        "[GET /api/gallery/detail] counter head failed",
        counterKey,
        e,
      )
    }
    return null
  })

  if (!meta) {
    // ì•„ì§ ì¹´ìš´í„°ê°€ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°
    return undefined
  }

  const url = (meta as any).downloadUrl || (meta as any).url
  if (!url || typeof url !== "string") {
    console.error(
      "[GET /api/gallery/detail] counter blob URL missing",
      counterKey,
      meta,
    )
    return undefined
  }

  const res = await fetch(url)
  if (!res.ok) {
    console.error(
      "[GET /api/gallery/detail] counter blob fetch failed",
      counterKey,
      res.status,
      await res.text().catch(() => ""),
    )
    return undefined
  }

  const text = await res.text().catch(() => "")
  if (
    !text ||
    text.startsWith("<!DOCTYPE") ||
    text.startsWith("<html") ||
    text.includes("Too Many Requests")
  ) {
    console.error(
      "[GET /api/gallery/detail] counter blob corrupted",
      counterKey,
      text.slice(0, 120),
    )
    return undefined
  }

  try {
    const data: any = JSON.parse(text)
    const v =
      typeof data.viewCount === "number"
        ? data.viewCount
        : typeof data.views === "number"
        ? data.views
        : undefined

    if (typeof v === "number" && v >= 0) {
      return v
    }
    return undefined
  } catch (e: any) {
    console.error(
      "[GET /api/gallery/detail] counter JSON parse failed",
      counterKey,
      e,
    )
    return undefined
  }
}

export async function GET(req: Request) {
  try {
    const { searchParams } = new URL(req.url)
    const encoded = searchParams.get("key") || ""

    if (!encoded) {
      console.error("[GET /api/gallery/detail] key missing")
      return errorJson("ìœ íš¨í•˜ì§€ ì•Šì€ key ì…ë‹ˆë‹¤. (ë¹„ì–´ ìˆìŒ)", 400)
    }

    let decoded: string
    try {
      decoded = decodeURIComponent(encoded).trim()
    } catch (e: any) {
      console.error("[GET /api/gallery/detail] decode failed", encoded, e)
      return errorJson("ìœ íš¨í•˜ì§€ ì•Šì€ key í˜•ì‹ì…ë‹ˆë‹¤.", 400)
    }

    if (
      !decoded ||
      !decoded.startsWith("galleries/") ||
      !decoded.endsWith(".json") ||
      decoded.includes("..") ||
      decoded.includes("//")
    ) {
      console.error("[GET /api/gallery/detail] key format error", decoded)
      return errorJson("ìœ íš¨í•˜ì§€ ì•Šì€ key í˜•ì‹ì…ë‹ˆë‹¤.", 400)
    }

    const meta = await head(decoded).catch((e: any) => {
      console.error("[GET /api/gallery/detail] head failed", decoded, e)
      return null
    })

    if (!meta) {
      return errorJson("ê°¤ëŸ¬ë¦¬ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", 404)
    }

    const url = (meta as any).downloadUrl || (meta as any).url

    if (!url || typeof url !== "string") {
      console.error("[GET /api/gallery/detail] blob URL missing", decoded, meta)
      return errorJson("ê°¤ëŸ¬ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", 500)
    }

    const res = await fetch(url)
    if (!res.ok) {
      console.error(
        "[GET /api/gallery/detail] blob fetch failed",
        decoded,
        res.status,
        await res.text().catch(() => ""),
      )
      return errorJson("ê°¤ëŸ¬ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", 500)
    }

    const raw = await res.json().catch((e: any) => {
      console.error("[GET /api/gallery/detail] blob JSON parse failed", decoded, e)
      return null
    })

    const itemBase = normalizeGalleryItem(raw, decoded)
    if (!itemBase) {
      console.error("[GET /api/gallery/detail] normalize failed", decoded, raw)
      return errorJson("ê°¤ëŸ¬ë¦¬ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", 500)
    }

    // ğŸ”¹ ì¡°íšŒìˆ˜ ì¹´ìš´í„° Blobì—ì„œ ê°’ ì½ì–´ì™€ì„œ merge
    let finalItem: GalleryItem = { ...itemBase }

    try {
      const counterViews = await readCounterViews(decoded)
      if (typeof counterViews === "number") {
        finalItem = {
          ...finalItem,
          viewCount: counterViews,
          // ê³¼ê±°/í˜¸í™˜ìš© í•„ë“œë„ ê°™ì´ ë§ì¶°ì¤€ë‹¤
          ...(counterViews >= 0 ? { views: counterViews } : {}),
        } as any
      }
    } catch (e: any) {
      console.error(
        "[GET /api/gallery/detail] counter merge failed",
        decoded,
        e,
      )
      // ì¡°íšŒìˆ˜ ì‹¤íŒ¨ëŠ” ì¹˜ëª…ì  ì—ëŸ¬ë¡œ ë³´ì§€ ì•Šê³ , ë³¸ë¬¸ë§Œì´ë¼ë„ ë°˜í™˜
    }

    return NextResponse.json({ ok: true, item: finalItem }, { status: 200 })
  } catch (e: any) {
    console.error("[GET /api/gallery/detail] server error", e)
    return errorJson("ì„œë²„ ì˜¤ë¥˜ë¡œ ê°¤ëŸ¬ë¦¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", 500)
  }
}

export async function POST() {
  return errorJson("Method Not Allowed", 405)
}
